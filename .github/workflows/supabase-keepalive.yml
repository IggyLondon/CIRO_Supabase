name: Keep Supabase Project Awake

on:
  schedule:
    # Run every 6 hours (safer than 5 days - ensures it never reaches 7 days)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then 
            echo "‚ùå Missing SUPABASE_URL secret"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then 
            echo "‚ùå Missing SUPABASE_ANON_KEY secret"
            exit 1
          fi
          echo "‚úÖ All secrets are configured"

      - name: Ping Supabase Database (with detailed logging)
        run: |
          set -e
          URL="${{ secrets.SUPABASE_URL }}/rest/v1/gallery_images?select=id&limit=1"
          echo "üîó Pinging: $URL"
          
          HTTP_CODE=$(curl -sS -o /tmp/response.txt -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            "$URL")
          
          echo "üìä HTTP Status: $HTTP_CODE"
          echo "üìÑ Response:"
          cat /tmp/response.txt
          echo ""
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Success! Supabase is responding correctly"
            exit 0
          else
            echo "‚ùå Failed with HTTP $HTTP_CODE"
            exit 1
          fi
      
      - name: Log Success
        if: success()
        run: echo "‚úÖ Supabase Gallery project pinged successfully at $(date)"
      
      - name: Log Failure
        if: failure()
        run: echo "‚ùå Failed to ping Supabase at $(date)"
